<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Server Action for Bulk Status Sync -->
    <record id="action_server_bulk_sync_status" model="ir.actions.server">
        <field name="name">Sync Status from Zid</field>
        <field name="model_id" ref="model_zid_sale_order"/>
        <field name="binding_model_id" ref="model_zid_sale_order"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    action = records.action_sync_status_from_zid()
        </field>
    </record>
    
    <!-- Server Action for Admin Bulk Sync All Pending -->
    <record id="action_server_bulk_sync_all_pending" model="ir.actions.server">
        <field name="name">Bulk Sync All Pending Orders</field>
        <field name="model_id" ref="model_zid_sale_order"/>
        <field name="state">code</field>
        <field name="code">
action = model.action_bulk_sync_all_pending()
        </field>
        <field name="groups_id" eval="[(4, ref('base.group_system'))]"/>
    </record>
    
    <!-- Server Action for Bulk Retry Create Sale Orders -->
    <record id="action_server_bulk_retry_sale_orders" model="ir.actions.server">
        <field name="name">Retry Create Sale Orders</field>
        <field name="model_id" ref="model_zid_sale_order"/>
        <field name="binding_model_id" ref="model_zid_sale_order"/>
        <field name="binding_view_types">list</field>
        <field name="state">code</field>
        <field name="code">
if records:
    success_count = 0
    error_count = 0
    errors = []
    
    for record in records:
        if record.sale_order_id:
            continue  # Skip if sale order already exists
            
        try:
            # Validate product mappings first
            is_valid, message = record.validate_product_mappings()
            if not is_valid:
                errors.append(f"Order {record.zid_order_id}: {message}")
                error_count += 1
                continue
                
            # Try to create sale order
            record.create_sale_order()
            success_count += 1
            
        except Exception as e:
            errors.append(f"Order {record.zid_order_id}: {str(e)}")
            error_count += 1
    
    # Show results
    if success_count > 0 and error_count == 0:
        action = {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Success',
                'message': f'Successfully created {success_count} sale orders',
                'type': 'success',
            }
        }
    elif success_count > 0 and error_count > 0:
        error_msg = f'Created {success_count} sale orders, {error_count} failed:\n' + '\n'.join(errors[:5])
        if len(errors) > 5:
            error_msg += f'\n... and {len(errors) - 5} more errors'
        action = {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Partial Success',
                'message': error_msg,
                'type': 'warning',
            }
        }
    else:
        error_msg = f'Failed to create sale orders:\n' + '\n'.join(errors[:5])
        if len(errors) > 5:
            error_msg += f'\n... and {len(errors) - 5} more errors'
        action = {
            'type': 'ir.actions.client',
            'tag': 'display_notification',
            'params': {
                'title': 'Error',
                'message': error_msg,
                'type': 'danger',
            }
        }
        </field>
    </record>
</odoo>